<!DOCTYPE html>
<html>
<head>
  <title>VERGE!</title>
  <style>
  #listener {
      width: 640px;
      height: 400px;
  }

  #listener embed {
      -webkit-transform: matrix(2, 0, 0, 2, 160, 100);
  }
  </style>
  <script type="text/javascript">
    V1naclModule = null;  // Global application object.
    statusText = 'NO-STATUS';

    function pushSave(index) {
        var state = localStorage.getItem('save' + index);
        if (!state) {
            console.log('No state for slot ' + index);
            return;
        }

        V1naclModule.postMessage('clear:' + index);
        var sliceIndex = 0;
        var SLICE_SIZE = 4096;
        while (sliceIndex < state.length) {
            var nextSlice = state.substr(sliceIndex, SLICE_SIZE);
            sliceIndex += SLICE_SIZE;
            V1naclModule.postMessage('append:' + index + ':' + nextSlice);
        }
        V1naclModule.postMessage('close:' + index);
    }

    // When the NaCl module has loaded, hook up an event listener to handle
    // messages coming from it via PPB_Messaging.PostMessage() (in C) or
    // pp::Instance.PostMessage() (in C++), and indicate success.
    function moduleDidLoad() {
        V1naclModule = document.getElementById('v1nacl');
        V1naclModule.addEventListener('message', handleMessage, false);
        updateStatus('SUCCESS');

        pushSave(0);
        pushSave(1);
        pushSave(2);
        pushSave(3);
   }

    // The 'message' event handler.  This handler is fired when the NaCl module
    // posts a message to the browser by calling PPB_Messaging.PostMessage()
    // (in C) or pp::Instance.PostMessage() (in C++).  This implementation
    // simply displays the content of the message in an alert panel.
    function handleMessage(message_event) {
        var d = message_event.data;
        
        if (!d) {
            console.log("Bad message data :(");
            return;
        }

        var s = d.split(':');
        if (s[0] == 'clear') {
            var index = s[1];
            localStorage.setItem('save' + index, '');
            return;
        } else if (s[0] == 'append') {
            var index = s[1];
            var data = s[2];
            var key = 'save' + index;
            var newValue = localStorage.getItem(key) + data;
            localStorage.setItem(key, newValue);
        } else {
            alert("Unknown message: " + d);
        }
    }

    // If the page loads before the Native Client module loads, then set the
    // status message indicating that the module is still loading.  Otherwise,
    // do not change the status message.
    function pageDidLoad() {
      if (V1naclModule == null) {
        updateStatus('LOADING...');
      } else {
        // It's possible that the Native Client module onload event fired
        // before the page's onload event.  In this case, the status message
        // will reflect 'SUCCESS', but won't be displayed.  This call will
        // display the current message.
        updateStatus();
      }
    }

    // Set the global status message.  If the element with id 'statusField'
    // exists, then set its HTML to the status message as well.
    // opt_message The message test.  If this is null or undefined, then
    // attempt to set the element with id 'statusField' to the value of
    // |statusText|.
    function updateStatus(opt_message) {
      if (opt_message)
        statusText = opt_message;
      var statusField = document.getElementById('status_field');
      if (statusField) {
        statusField.innerHTML = statusText;
      }
    }
  </script>
</head>
<body onload="pageDidLoad()">

<h1>Native Client Module V1nacl</h1>
<p>
  <!-- Load the published .nexe.  This includes the 'nacl' attribute which
  shows how to load multi-architecture modules.  Each entry in the "nexes"
  object in the .nmf manifest file is a key-value pair: the key is the
  instruction set architecture ('x86-32', 'x86-64', etc.); the value is a URL
  for the desired NaCl module.
  To load the debug versions of your .nexes, set the 'nacl' attribute to the
  _dbg.nmf version of the manifest file.

  Note: Since this NaCl module does not use any real-estate in the browser,
  it's width and height are set to 0.

  Note: The <EMBED> element is wrapped inside a <DIV>, which has a 'load'
  event listener attached.  This wrapping method is used instead of attaching
  the 'load' event listener directly to the <EMBED> element to ensure that the
  listener is active before the NaCl module 'load' event fires.
  -->
  <div id="listener">
    <script type="text/javascript">
       document.getElementById('listener')
          .addEventListener('load', moduleDidLoad, true);
    </script>

    <embed name="nacl_module"
       id="v1nacl"
       width=320 height=200
       src="v1nacl.nmf"
       type="application/x-nacl"
       game_url="sots"
       />
  </div>
</p>

<h2>Controls</h2>
<dl>
    <dt>Arrow keys</dt><dd>Move</dd>
    <dt>Enter</dt><dd>Interact, select menu options</dd>
    <dt>Tab</dt><dd>Cancel out of menus</dd>
    <dt>Space</dt><dd>Main menu (items, equipment, etc)</dd>
    <dt>ESC</dt><dd>System menu (save, load, etc)</dd>
</dl>
<h2>Status</h2>
<div id="status_field">NO-STATUS</div>
   
</body>
</html>
